# ç¬¬ä¸€é˜¶æ®µè¯¦ç»†å®æ–½è®¡åˆ’

## ğŸ¯ é˜¶æ®µç›®æ ‡

**æ—¶é—´å‘¨æœŸ**: 4-6å‘¨
**ä¼˜å…ˆçº§**: é«˜
**é£é™©ç­‰çº§**: ä½
**é¢„æœŸæ”¶ç›Š**: ä¸­ç­‰

### å…³é”®æŒ‡æ ‡ç›®æ ‡
- **Precision@10**: åŸºçº¿ â†’ +20%
- **æŸ¥è¯¢ç†è§£å‡†ç¡®ç‡**: > 85%
- **é‡æ’åºå»¶è¿Ÿ**: < 50ms
- **æµ‹è¯•è¦†ç›–ç‡**: ä¿æŒ 90%+

## ğŸ“… è¯¦ç»†æ—¶é—´è§„åˆ’

### Week 1-2: é‡æ’åºæœºåˆ¶å®ç°
**è´Ÿè´£äºº**: æ ¸å¿ƒå¼€å‘å·¥ç¨‹å¸ˆ
**é‡Œç¨‹ç¢‘**: å®ŒæˆåŸºç¡€é‡æ’åºåŠŸèƒ½

#### Week 1: æ¶æ„è®¾è®¡ä¸åŸºç¡€å®ç°
**Day 1-2: æ¶æ„è®¾è®¡**
- [ ] è®¾è®¡é‡æ’åºå¤„ç†å™¨æ¥å£è§„èŒƒ
- [ ] å®šä¹‰RetrievalResultæ•°æ®æ¨¡å‹
- [ ] è®¾è®¡é‡æ’åºé…ç½®å‚æ•°ç»“æ„
- [ ] è¯„å®¡æ¶æ„è®¾è®¡æ–¹æ¡ˆ

**Day 3-5: æ ¸å¿ƒæ¨¡å—å¼€å‘**
- [ ] å®ç°`processors/reranking_processor.py`
- [ ] å®ç°`processors/similarity_processor.py`
- [ ] å®ç°`config/reranking_config.py`
- [ ] ç¼–å†™åŸºç¡€å•å…ƒæµ‹è¯•

#### Week 2: é›†æˆä¸ä¼˜åŒ–
**Day 1-2: ç®¡é“é›†æˆ**
- [ ] ä¿®æ”¹`pipelines/retrieval_pipeline.py`é›†æˆé‡æ’åº
- [ ] æ‰©å±•`schemas/data_models.py`æ”¯æŒé‡æ’åºç»“æœ
- [ ] å®ç°é‡æ’åºç»“æœç¼“å­˜æœºåˆ¶

**Day 3-5: ç®—æ³•ä¼˜åŒ–**
- [ ] å®ç°cosineç›¸ä¼¼åº¦é‡æ’åº
- [ ] å®ç°Learning to Ranké‡æ’åº
- [ ] æ€§èƒ½è°ƒä¼˜å’Œå†…å­˜ä¼˜åŒ–
- [ ] å®Œå–„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

### Week 3-4: å¤šç»´ç›¸ä¼¼æ€§è¯„ä¼°
**è´Ÿè´£äºº**: ç®—æ³•å·¥ç¨‹å¸ˆ
**é‡Œç¨‹ç¢‘**: å®Œæˆå¤šç»´ç›¸ä¼¼æ€§è®¡ç®—æ¨¡å—

#### Week 3: ç›¸ä¼¼æ€§æŒ‡æ ‡å®ç°
**Day 1-2: æŒ‡æ ‡è®¾è®¡**
- [ ] è®¾è®¡è¯­ä¹‰ç›¸ä¼¼æ€§è®¡ç®—æ–¹æ³•
- [ ] è®¾è®¡è§†è§‰ç›¸ä¼¼æ€§è®¡ç®—æ–¹æ³•
- [ ] è®¾è®¡åœºæ™¯ç›¸ä¼¼æ€§è®¡ç®—æ–¹æ³•
- [ ] åˆ¶å®šç›¸ä¼¼æ€§èåˆç­–ç•¥

**Day 3-5: æ¨¡å—å¼€å‘**
- [ ] å®ç°`processors/similarity_calculator.py`
- [ ] å®ç°`utils/similarity_metrics.py`
- [ ] å®ç°`config/similarity_config.py`
- [ ] ç¼–å†™ç›¸ä¼¼æ€§è®¡ç®—æµ‹è¯•ç”¨ä¾‹

#### Week 4: ç‰¹å¾æå–å¢å¼º
**Day 1-2: å›¾åƒç‰¹å¾å¢å¼º**
- [ ] æ‰©å±•`processors/image_processor.py`è§†è§‰ç‰¹å¾æå–
- [ ] å®ç°å›¾åƒç»“æ„ç›¸ä¼¼æ€§è®¡ç®—
- [ ] é›†æˆOpenCVé«˜çº§ç‰¹å¾æå–

**Day 3-5: å­˜å‚¨ç³»ç»Ÿæ‰©å±•**
- [ ] ä¿®æ”¹`vector_store/faiss_store.py`æ”¯æŒå¤šç±»å‹å‘é‡
- [ ] æ‰©å±•`schemas/data_models.py`æ”¯æŒå¤šç»´ç‰¹å¾
- [ ] å®ç°ç‰¹å¾å‘é‡ç´¢å¼•ä¼˜åŒ–
- [ ] å®Œå–„å¤šç»´ç›¸ä¼¼æ€§æµ‹è¯•

### Week 5-6: æŸ¥è¯¢ç†è§£ä¼˜åŒ–
**è´Ÿè´£äºº**: NLPå·¥ç¨‹å¸ˆ
**é‡Œç¨‹ç¢‘**: å®Œæˆæ™ºèƒ½æŸ¥è¯¢ç†è§£ç³»ç»Ÿ

#### Week 5: æŸ¥è¯¢å¤„ç†æ ¸å¿ƒ
**Day 1-2: æŸ¥è¯¢åˆ†ç±»å™¨**
- [ ] å®ç°æŸ¥è¯¢ç±»å‹åˆ†ç±»ç®—æ³•
- [ ] è®­ç»ƒæŸ¥è¯¢æ„å›¾è¯†åˆ«æ¨¡å‹
- [ ] å®ç°æŸ¥è¯¢å¤æ‚åº¦è¯„ä¼°

**Day 3-5: æŸ¥è¯¢æ‰©å±•**
- [ ] å®ç°`processors/query_processor.py`
- [ ] å®ç°`utils/query_expansion.py`
- [ ] é›†æˆåŒä¹‰è¯æ‰©å±•å’Œæ¦‚å¿µæ˜ å°„
- [ ] å®ç°è´Ÿæ ·æœ¬è¿‡æ»¤é€»è¾‘

#### Week 6: æç¤ºè¯ä¼˜åŒ–ä¸é›†æˆ
**Day 1-2: æç¤ºè¯ç®¡ç†**
- [ ] æ‰©å±•`clients/prompt_manager.py`
- [ ] å®ç°æŸ¥è¯¢ç‰¹åŒ–æç¤ºè¯æ¨¡æ¿
- [ ] ä¼˜åŒ–ä¸åŒæŸ¥è¯¢ç±»å‹çš„å¤„ç†ç­–ç•¥

**Day 3-5: ç³»ç»Ÿé›†æˆ**
- [ ] é›†æˆæŸ¥è¯¢å¤„ç†åˆ°æ£€ç´¢ç®¡é“
- [ ] å®ç°ç«¯åˆ°ç«¯æŸ¥è¯¢ä¼˜åŒ–æµç¨‹
- [ ] å®Œå–„æŸ¥è¯¢ç†è§£æµ‹è¯•å¥—ä»¶
- [ ] æ€§èƒ½è°ƒä¼˜å’Œæ–‡æ¡£å®Œå–„

## ğŸ”§ æŠ€æœ¯å®æ–½ç»†èŠ‚

### 1. é‡æ’åºå¤„ç†å™¨è®¾è®¡

#### æ ¸å¿ƒæ¥å£è®¾è®¡
```python
class RerankingProcessor:
    """é‡æ’åºå¤„ç†å™¨"""

    def __init__(self, config: RerankingConfig):
        self.config = config
        self.similarity_processor = SimilarityProcessor()

    async def rerank_results(
        self,
        query: str,
        candidates: List[RetrievalResult],
        top_k: int = 20
    ) -> List[RetrievalResult]:
        """é‡æ’åºæ£€ç´¢ç»“æœ"""

    def calculate_relevance_score(
        self,
        query: str,
        result: RetrievalResult
    ) -> float:
        """è®¡ç®—ç›¸å…³æ€§åˆ†æ•°"""
```

#### é‡æ’åºç®—æ³•å®ç°
```python
# 1. ç®€å•cosineç›¸ä¼¼åº¦é‡æ’åº
def cosine_rerank(query_embedding, candidate_embeddings):
    similarities = cosine_similarity(query_embedding, candidate_embeddings)
    return np.argsort(similarities)[::-1]

# 2. Learning to Ranké‡æ’åº
def learning_to_rank_rerank(features, model):
    scores = model.predict(features)
    return np.argsort(scores)[::-1]

# 3. å¤šç‰¹å¾èåˆé‡æ’åº
def multi_feature_fusion_rerank(semantic_sim, visual_sim, scene_sim, weights):
    combined_score = (weights[0] * semantic_sim +
                     weights[1] * visual_sim +
                     weights[2] * scene_sim)
    return np.argsort(combined_score)[::-1]
```

### 2. å¤šç»´ç›¸ä¼¼æ€§è®¡ç®—

#### ç›¸ä¼¼æ€§æŒ‡æ ‡å®ç°
```python
class SimilarityCalculator:
    """å¤šç»´ç›¸ä¼¼æ€§è®¡ç®—å™¨"""

    def semantic_similarity(self, query_text: str, image_desc: str) -> float:
        """è¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®—"""
        # ä½¿ç”¨sentence-transformersè®¡ç®—è¯­ä¹‰ç›¸ä¼¼åº¦

    def visual_similarity(self, query_features: np.ndarray, image_features: np.ndarray) -> float:
        """è§†è§‰ç›¸ä¼¼åº¦è®¡ç®—"""
        # ä½¿ç”¨æ·±åº¦ç‰¹å¾è®¡ç®—è§†è§‰ç›¸ä¼¼åº¦

    def scene_similarity(self, query_scene: str, image_scene: str) -> float:
        """åœºæ™¯ç›¸ä¼¼åº¦è®¡ç®—"""
        # åŸºäºåœºæ™¯åˆ†ç±»çš„ç›¸ä¼¼åº¦è®¡ç®—

    def face_similarity(self, query_face: np.ndarray, image_face: np.ndarray) -> float:
        """äººè„¸ç›¸ä¼¼åº¦è®¡ç®—"""
        # äººè„¸ç‰¹å¾å‘é‡ç›¸ä¼¼åº¦è®¡ç®—
```

### 3. æŸ¥è¯¢ç†è§£ç³»ç»Ÿ

#### æŸ¥è¯¢åˆ†ç±»å™¨
```python
class QueryClassifier:
    """æŸ¥è¯¢åˆ†ç±»å™¨"""

    QUERY_TYPES = {
        "object": "ç‰©ä½“æŸ¥è¯¢",
        "scene": "åœºæ™¯æŸ¥è¯¢",
        "person": "äººç‰©æŸ¥è¯¢",
        "action": "åŠ¨ä½œæŸ¥è¯¢",
        "composite": "å¤åˆæŸ¥è¯¢"
    }

    def classify_query(self, query: str) -> Dict[str, float]:
        """æŸ¥è¯¢ç±»å‹åˆ†ç±»"""

    def extract_query_entities(self, query: str) -> List[str]:
        """æå–æŸ¥è¯¢å®ä½“"""

    def estimate_query_complexity(self, query: str) -> float:
        """è¯„ä¼°æŸ¥è¯¢å¤æ‚åº¦"""
```

#### æŸ¥è¯¢æ‰©å±•ç­–ç•¥
```python
class QueryExpander:
    """æŸ¥è¯¢æ‰©å±•å™¨"""

    def synonym_expansion(self, query: str) -> List[str]:
        """åŒä¹‰è¯æ‰©å±•"""

    def concept_expansion(self, query: str) -> List[str]:
        """æ¦‚å¿µæ‰©å±•"""

    def negative_filtering(self, query: str) -> List[str]:
        """è´Ÿæ ·æœ¬è¿‡æ»¤å…³é”®è¯"""
```

## ğŸ“‹ ä¾èµ–ä¸ç¯å¢ƒè¦æ±‚

### æ–°å¢Pythonä¾èµ–
```python
# requirements_stage1.txt
scikit-learn>=1.3.0        # æœºå™¨å­¦ä¹ ç®—æ³•
nltk>=3.8                  # è‡ªç„¶è¯­è¨€å¤„ç†
textdistance>=4.5.0        # æ–‡æœ¬ç›¸ä¼¼åº¦
opencv-python>=4.8.0       # å›¾åƒå¤„ç†
sentence-transformers>=2.2.2  # å¥å­embedding

# å¯é€‰ä¼˜åŒ–åº“
lightgbm>=3.3.5            # è½»é‡æ¢¯åº¦æå‡(é‡æ’åº)
xgboost>=1.7.0             # æ¢¯åº¦æå‡(ç‰¹å¾èåˆ)

# æµ‹è¯•ä¾èµ–
pytest-benchmark>=4.0.0    # æ€§èƒ½æµ‹è¯•
pytest-mock>=3.10.0       # Mockæµ‹è¯•
memory-profiler>=0.60.0   # å†…å­˜åˆ†æ
```

### ç¯å¢ƒé…ç½®
```bash
# å®‰è£…ä¾èµ–
pip install -r requirements_stage1.txt

# ä¸‹è½½NLTKæ•°æ®
python -c "import nltk; nltk.download('punkt'); nltk.download('stopwords')"

# ä¸‹è½½sentence-transformersæ¨¡å‹
python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('all-MiniLM-L6-v2')"
```

## ğŸ§ª æµ‹è¯•è®¡åˆ’è¯¦è¿°

### å•å…ƒæµ‹è¯• (Week 1-6 å¹¶è¡Œ)

#### é‡æ’åºæ¨¡å—æµ‹è¯•
```python
# tests/unit/test_reranking_processor.py
class TestRerankingProcessor:

    def test_rerank_results_basic(self):
        """æµ‹è¯•åŸºç¡€é‡æ’åºåŠŸèƒ½"""

    def test_rerank_results_empty_candidates(self):
        """æµ‹è¯•ç©ºå€™é€‰é›†å¤„ç†"""

    def test_rerank_performance(self):
        """æµ‹è¯•é‡æ’åºæ€§èƒ½"""

    @pytest.mark.benchmark
    def test_rerank_latency_benchmark(self):
        """é‡æ’åºå»¶è¿ŸåŸºå‡†æµ‹è¯•"""
```

#### ç›¸ä¼¼æ€§è®¡ç®—æµ‹è¯•
```python
# tests/unit/test_similarity_processor.py
class TestSimilarityProcessor:

    def test_semantic_similarity_calculation(self):
        """æµ‹è¯•è¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®—"""

    def test_visual_similarity_calculation(self):
        """æµ‹è¯•è§†è§‰ç›¸ä¼¼åº¦è®¡ç®—"""

    def test_multi_dimensional_similarity_fusion(self):
        """æµ‹è¯•å¤šç»´ç›¸ä¼¼åº¦èåˆ"""
```

#### æŸ¥è¯¢å¤„ç†æµ‹è¯•
```python
# tests/unit/test_query_processor.py
class TestQueryProcessor:

    def test_query_classification(self):
        """æµ‹è¯•æŸ¥è¯¢åˆ†ç±»"""

    def test_query_expansion(self):
        """æµ‹è¯•æŸ¥è¯¢æ‰©å±•"""

    def test_query_processing_performance(self):
        """æµ‹è¯•æŸ¥è¯¢å¤„ç†æ€§èƒ½"""
```

### é›†æˆæµ‹è¯• (Week 6)

#### ç«¯åˆ°ç«¯æ£€ç´¢æµ‹è¯•
```python
# tests/integration/test_enhanced_retrieval.py
class TestEnhancedRetrieval:

    def test_end_to_end_retrieval_with_reranking(self):
        """æµ‹è¯•åŒ…å«é‡æ’åºçš„ç«¯åˆ°ç«¯æ£€ç´¢"""

    def test_multi_dimensional_similarity_integration(self):
        """æµ‹è¯•å¤šç»´ç›¸ä¼¼æ€§é›†æˆ"""

    def test_query_understanding_integration(self):
        """æµ‹è¯•æŸ¥è¯¢ç†è§£é›†æˆ"""
```

### æ€§èƒ½æµ‹è¯• (Week 6)

#### åŸºå‡†æ€§èƒ½æµ‹è¯•
```python
# tests/performance/test_stage1_benchmark.py
class TestStage1Benchmark:

    @pytest.mark.benchmark
    def test_reranking_latency(self):
        """é‡æ’åºå»¶è¿Ÿæµ‹è¯• - ç›®æ ‡: <50ms"""

    @pytest.mark.benchmark
    def test_similarity_calculation_throughput(self):
        """ç›¸ä¼¼åº¦è®¡ç®—ååé‡æµ‹è¯•"""

    @pytest.mark.benchmark
    def test_query_processing_latency(self):
        """æŸ¥è¯¢å¤„ç†å»¶è¿Ÿæµ‹è¯•"""
```

## ğŸ“Š è´¨é‡ä¿è¯æªæ–½

### ä»£ç è´¨é‡æ£€æŸ¥
```bash
# ä»£ç é£æ ¼æ£€æŸ¥
flake8 processors/ utils/ --max-line-length=100
black --check processors/ utils/
isort --check-only processors/ utils/

# ç±»å‹æ£€æŸ¥
mypy processors/ utils/ --ignore-missing-imports

# æµ‹è¯•è¦†ç›–ç‡
pytest --cov=processors --cov=utils --cov-report=html --cov-fail-under=90
```

### æ€§èƒ½ç›‘æ§
```python
# å…³é”®æ€§èƒ½æŒ‡æ ‡ç›‘æ§
PERFORMANCE_TARGETS = {
    "reranking_latency": 50,  # ms
    "similarity_calc_latency": 10,  # ms
    "query_processing_latency": 20,  # ms
    "end_to_end_latency": 200,  # ms
    "precision_at_10_improvement": 0.20,  # 20%æå‡
}
```

### å›å½’æµ‹è¯•
```python
# å›å½’æµ‹è¯•å¥—ä»¶
REGRESSION_TESTS = [
    "ç°æœ‰åŠŸèƒ½ä¸å—å½±å“",
    "æ£€ç´¢ç²¾åº¦ä¸é™ä½",
    "æ£€ç´¢é€Ÿåº¦ä¸æ˜æ˜¾ä¸‹é™",
    "å†…å­˜ä½¿ç”¨ä¸æ˜¾è‘—å¢åŠ "
]
```

## ğŸš¨ é£é™©æ§åˆ¶

### æŠ€æœ¯é£é™©
1. **é‡æ’åºæ€§èƒ½é£é™©**: å»¶è¿Ÿè¶…è¿‡50msç›®æ ‡
   - **ç¼“è§£**: å®ç°å¤šçº§ç¼“å­˜å’Œå¼‚æ­¥å¤„ç†
2. **ç›¸ä¼¼æ€§è®¡ç®—ç²¾åº¦é£é™©**: å¤šç»´èåˆæ•ˆæœä¸ä½³
   - **ç¼“è§£**: A/Bæµ‹è¯•ä¸åŒèåˆç­–ç•¥
3. **æŸ¥è¯¢ç†è§£å‡†ç¡®ç‡é£é™©**: è¾¾ä¸åˆ°85%ç›®æ ‡
   - **ç¼“è§£**: å¢åŠ è®­ç»ƒæ•°æ®å’Œæ¨¡å‹è°ƒä¼˜

### é¡¹ç›®é£é™©
1. **æ—¶é—´å»¶æœŸé£é™©**: 6å‘¨å†…æ— æ³•å®Œæˆ
   - **ç¼“è§£**: æ¯å‘¨é‡Œç¨‹ç¢‘æ£€æŸ¥å’Œä¼˜å…ˆçº§è°ƒæ•´
2. **èµ„æºä¸è¶³é£é™©**: äººåŠ›æˆ–è®¡ç®—èµ„æºä¸å¤Ÿ
   - **ç¼“è§£**: æå‰èµ„æºè§„åˆ’å’Œå¤‡ç”¨æ–¹æ¡ˆ

### è´¨é‡é£é™©
1. **æµ‹è¯•è¦†ç›–ä¸è¶³**: 90%è¦†ç›–ç‡ç›®æ ‡
   - **ç¼“è§£**: TDDå¼€å‘æ¨¡å¼å’ŒæŒç»­é›†æˆ
2. **æ€§èƒ½é€€åŒ–**: å½±å“ç°æœ‰ç³»ç»Ÿæ€§èƒ½
   - **ç¼“è§£**: æ€§èƒ½åŸºå‡†æµ‹è¯•å’Œç›‘æ§å‘Šè­¦

---

*è®¡åˆ’ç‰ˆæœ¬: v1.0*
*åˆ¶å®šæ—¥æœŸ: 2025-08-25*
*è®¡åˆ’è´Ÿè´£äºº: QwenRagå¼€å‘å›¢é˜Ÿ*
