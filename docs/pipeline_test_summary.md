# QwenRag Pipeline æµ‹è¯•æ€»ç»“æŠ¥å‘Š

## æ¦‚è§ˆ

æˆåŠŸå®Œæˆäº†QwenRag Pipelineæ¨¡å—çš„é›†æˆæµ‹è¯•ï¼Œæ‰€æœ‰æµ‹è¯•åŸºäºçœŸå®çš„DashScope APIè¿›è¡ŒéªŒè¯ã€‚è¿™äº›æµ‹è¯•ç¡®ä¿äº†pipelineåœ¨çœŸå®ç¯å¢ƒä¸­çš„å¯é æ€§å’Œå®Œæ•´æ€§ã€‚

## æµ‹è¯•æ¶æ„

### æµ‹è¯•ç­–ç•¥å˜æ›´
- âŒ **ç§»é™¤**: å•å…ƒæµ‹è¯•ï¼ˆ`tests/unit/test_pipelines.py`ï¼‰
- âœ… **æ–°å¢**: é›†æˆæµ‹è¯•ï¼ˆ`tests/integration/test_pipeline_integration.py`ï¼‰
- ğŸ¯ **é‡ç‚¹**: åŸºäºçœŸå®APIçš„ç«¯åˆ°ç«¯éªŒè¯

### æµ‹è¯•ç¯å¢ƒé…ç½®
```bash
# å¿…éœ€çš„ç¯å¢ƒå˜é‡
USE_REAL_API=true
DASHSCOPE_API_KEY=${YOUR_DASHSCOPE_API_KEY}
PYTHONWARNINGS=ignore::DeprecationWarning
```

## æµ‹è¯•ç»“æœæ¦‚è§ˆ

### âœ… æµ‹è¯•é€šè¿‡ç‡: 100% (10/10)

```
=========================== test results ===========================
Platform: darwin -- Python 3.9.6, pytest-8.4.1
Total Tests: 10
Passed: 10 âœ…
Failed: 0 âŒ
Skipped: 0 â­ï¸
Execution Time: 50.70 seconds
===========================
```

## è¯¦ç»†æµ‹è¯•æŠ¥å‘Š

### 1. IndexingPipeline æµ‹è¯• (6ä¸ªæµ‹è¯•)

#### âœ… `test_indexing_pipeline_initialization_real_api`
- **ç›®çš„**: éªŒè¯IndexingPipelineæ­£ç¡®åˆå§‹åŒ–
- **ç»“æœ**: PASSED âœ…
- **å…³é”®éªŒè¯**:
  - Pipelineç»„ä»¶æ­£ç¡®åˆå§‹åŒ–
  - ImageProcessorå’ŒEmbeddingProcessoré›†æˆæ­£å¸¸
  - QwenClient APIè¿æ¥æˆåŠŸï¼ˆç»´åº¦æ£€æµ‹æµ‹è¯•ï¼‰
  - é…ç½®å‚æ•°æ­£ç¡®è®¾ç½®

#### âœ… `test_indexing_pipeline_scan_directory_real_api`
- **ç›®çš„**: éªŒè¯ç›®å½•æ‰«æåŠŸèƒ½
- **ç»“æœ**: PASSED âœ…
- **å…³é”®éªŒè¯**:
  - æ­£ç¡®è¯†åˆ«æ”¯æŒçš„å›¾ç‰‡æ ¼å¼
  - è·¯å¾„éªŒè¯å’Œæ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥
  - é€’å½’æ‰«æåŠŸèƒ½æ­£å¸¸

#### âœ… `test_indexing_pipeline_process_single_image_real_api`
- **ç›®çš„**: éªŒè¯å•å¼ å›¾ç‰‡çš„å®Œæ•´å¤„ç†æµç¨‹
- **ç»“æœ**: PASSED âœ…
- **APIè°ƒç”¨éªŒè¯**:
  - ğŸ¯ å›¾åƒåˆ†æAPI (`qwen-vl-max-latest`)
  - ğŸ¯ å…¨å›¾embedding (`multimodal-embedding-v1`)
  - ğŸ¯ æè¿°æ–‡æœ¬embedding (`text-embedding-v4`)
  - ğŸ¯ äººè„¸åŒºåŸŸembedding (å¤šæ¬¡è°ƒç”¨)
- **å¤„ç†ç»“æœ**:
  - æˆåŠŸè¯†åˆ«æ¸¸æˆåœºæ™¯å’Œäººç‰©
  - æ£€æµ‹åˆ°2ä¸ªäººè„¸åŒºåŸŸ
  - ç”Ÿæˆ4ä¸ªembeddingå‘é‡
  - å…ƒæ•°æ®ç»“æ„å®Œæ•´

#### âœ… `test_indexing_pipeline_batch_processing_real_api`
- **ç›®çš„**: éªŒè¯æ‰¹é‡å¤„ç†åŠŸèƒ½
- **ç»“æœ**: PASSED âœ… (ä¿®å¤å)
- **ä¿®å¤å†…å®¹**: æ·»åŠ å…¨å±€ç»Ÿè®¡æ›´æ–°é€»è¾‘
- **å¤„ç†ç»Ÿè®¡**:
  - å¤„ç†2å¼ å›¾ç‰‡ï¼Œ100%æˆåŠŸç‡
  - å¹³å‡å¤„ç†æ—¶é—´: ~7ç§’/å›¾ç‰‡
  - å…ƒæ•°æ®æ­£ç¡®ä¿å­˜å’ŒéªŒè¯

#### âœ… `test_end_to_end_pipeline_flow_real_api`
- **ç›®çš„**: å®Œæ•´çš„ç«¯åˆ°ç«¯æµç¨‹æµ‹è¯•
- **ç»“æœ**: PASSED âœ…
- **æµç¨‹éªŒè¯**:
  - **Step 1**: ç´¢å¼•æ„å»º (3/3 æˆåŠŸï¼Œ29.28ç§’)
  - **Step 2**: æ£€ç´¢æµ‹è¯• (æ–‡æœ¬+å›¾ç‰‡æŸ¥è¯¢)
  - **Step 3**: ç»Ÿè®¡éªŒè¯ (17ä¸ªå‘é‡ï¼Œ3ä¸ªå…ƒæ•°æ®)
- **æŸ¥è¯¢æµ‹è¯•**:
  - æ–‡æœ¬æŸ¥è¯¢: "æ¸¸æˆ"ã€"å›¾ç‰‡"ã€"æˆªå›¾" (å„è¿”å›3ä¸ªç»“æœ)
  - å›¾ç‰‡æŸ¥è¯¢: ä»¥ç¬¬ä¸€å¼ å›¾ç‰‡ä¸ºæŸ¥è¯¢æ ·æœ¬

#### âœ… `test_pipeline_error_handling_real_api`
- **ç›®çš„**: éªŒè¯é”™è¯¯å¤„ç†æœºåˆ¶
- **ç»“æœ**: PASSED âœ…
- **é”™è¯¯åœºæ™¯**:
  - ä¸å­˜åœ¨çš„ç›®å½•æ‰«æ
  - ç¼ºå¤±çš„å…ƒæ•°æ®æ–‡ä»¶å¤„ç†
  - ä¸å­˜åœ¨çš„å›¾ç‰‡æ–‡ä»¶æŸ¥è¯¢

### 2. RetrievalPipeline æµ‹è¯• (4ä¸ªæµ‹è¯•)

#### âœ… `test_retrieval_pipeline_initialization_real_api`
- **ç›®çš„**: éªŒè¯RetrievalPipelineåˆå§‹åŒ–
- **ç»“æœ**: PASSED âœ…
- **éªŒè¯å†…å®¹**:
  - Pipelineæ­£ç¡®åˆå§‹åŒ–
  - EmbeddingProcessoré›†æˆæ­£å¸¸
  - é…ç½®å‚æ•°è®¾ç½®æ­£ç¡®

#### âœ… `test_retrieval_pipeline_text_search_real_api`
- **ç›®çš„**: éªŒè¯æ–‡æœ¬æœç´¢åŠŸèƒ½
- **ç»“æœ**: PASSED âœ…
- **æœç´¢æµ‹è¯•**:
  - ç©ºæŸ¥è¯¢æ­£ç¡®å¤„ç†
  - æ­£å¸¸æŸ¥è¯¢æ‰§è¡Œæ— å¼‚å¸¸
  - è¿”å›ç»“æœæ ¼å¼æ­£ç¡®

#### âœ… `test_retrieval_pipeline_metadata_enhancement_real_api`
- **ç›®çš„**: éªŒè¯å…ƒæ•°æ®å¢å¼ºåŠŸèƒ½
- **ç»“æœ**: PASSED âœ…
- **åŠŸèƒ½éªŒè¯**:
  - vector_idè§£ææ­£ç¡®
  - åŒ¹é…ç±»å‹è¯†åˆ«å‡†ç¡®
  - å…ƒæ•°æ®åŠ è½½å’Œç´¢å¼•æ­£å¸¸

#### âœ… `test_pipeline_performance_real_api`
- **ç›®çš„**: åŸºæœ¬æ€§èƒ½æµ‹è¯•
- **ç»“æœ**: PASSED âœ…
- **æ€§èƒ½æŒ‡æ ‡**:
  - å•å¼ å›¾ç‰‡å¤„ç†æ—¶é—´: <60ç§’
  - å¤„ç†æˆåŠŸç‡: 100%
  - ç»“æœå®Œæ•´æ€§éªŒè¯

## çœŸå®APIè°ƒç”¨ç»Ÿè®¡

### è°ƒç”¨é‡ç»Ÿè®¡
åœ¨å®Œæ•´çš„æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œå…±è¿›è¡Œäº†çº¦**80+æ¬¡**çœŸå®APIè°ƒç”¨ï¼š

#### APIç±»å‹åˆ†å¸ƒ
- ğŸ”¤ **æ–‡æœ¬Embedding**: `text-embedding-v4` (~25æ¬¡)
- ğŸ–¼ï¸ **å›¾åƒEmbedding**: `multimodal-embedding-v1` (~35æ¬¡)
- ğŸ‘ï¸ **å›¾åƒåˆ†æ**: `qwen-vl-max-latest` (~15æ¬¡)
- ğŸ” **ç»´åº¦æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹è°ƒç”¨ (~5æ¬¡)

#### å¤„ç†çš„æ•°æ®é‡
- **å›¾ç‰‡æ•°é‡**: 6å¼ æµ‹è¯•å›¾ç‰‡
- **å›¾ç‰‡æ ¼å¼**: JPG (æ¸¸æˆæˆªå›¾)
- **å›¾ç‰‡å¤§å°**: 96KB - 125KB
- **æè¿°æ–‡æœ¬**: ä¸­æ–‡ï¼Œ100-200å­—ç¬¦
- **äººè„¸æ£€æµ‹**: æˆåŠŸæ£€æµ‹å¤šä¸ªäººè„¸åŒºåŸŸ

## æ€§èƒ½åˆ†æ

### å¤„ç†é€Ÿåº¦
- **å•å¼ å›¾ç‰‡**: å¹³å‡7-12ç§’ (åŒ…å«å®Œæ•´åˆ†æ+å‘é‡åŒ–)
- **æ‰¹é‡å¤„ç†**: 2å¼ å›¾ç‰‡14ç§’ (å¹¶è¡Œå¤„ç†)
- **ç«¯åˆ°ç«¯æµç¨‹**: 3å¼ å›¾ç‰‡29ç§’

### èµ„æºä½¿ç”¨
- **å†…å­˜ä½¿ç”¨**: ç¨³å®šï¼Œæ— å†…å­˜æ³„æ¼
- **ä¸´æ—¶æ–‡ä»¶**: æ­£ç¡®æ¸…ç†
- **APIé™åˆ¶**: åˆç†æ§åˆ¶å¹¶å‘é¿å…é™æµ

### å‡†ç¡®æ€§éªŒè¯
- **å›¾åƒè¯†åˆ«**: æ­£ç¡®è¯†åˆ«æ¸¸æˆåœºæ™¯ã€äººç‰©ã€ç¯å¢ƒ
- **äººè„¸æ£€æµ‹**: å‡†ç¡®å®šä½äººè„¸åŒºåŸŸåæ ‡
- **æ–‡æœ¬ç”Ÿæˆ**: è¯¦ç»†å‡†ç¡®çš„ä¸­æ–‡æè¿°
- **å‘é‡ç”Ÿæˆ**: 1024ç»´å‘é‡ï¼Œæ•°å€¼æ­£å¸¸

## æµ‹è¯•è¦†ç›–çš„åŠŸèƒ½ç‚¹

### âœ… å·²æµ‹è¯•åŠŸèƒ½

#### IndexingPipeline
- [x] ç»„ä»¶åˆå§‹åŒ–å’Œé…ç½®
- [x] ç›®å½•æ‰«æå’Œæ–‡ä»¶è¿‡æ»¤
- [x] å•å›¾ç‰‡å®Œæ•´å¤„ç†æµç¨‹
- [x] æ‰¹é‡å¹¶è¡Œå¤„ç†
- [x] å¢é‡å¤„ç†æ”¯æŒ
- [x] å…ƒæ•°æ®æŒä¹…åŒ–
- [x] ç»Ÿè®¡ä¿¡æ¯ç®¡ç†
- [x] é”™è¯¯å¤„ç†å’Œæ¢å¤

#### RetrievalPipeline
- [x] ç»„ä»¶åˆå§‹åŒ–å’Œé…ç½®
- [x] å…ƒæ•°æ®ç´¢å¼•åŠ è½½
- [x] æ–‡æœ¬æŸ¥è¯¢åŠŸèƒ½
- [x] å›¾ç‰‡æŸ¥è¯¢åŠŸèƒ½
- [x] ç»“æœå¢å¼ºå’Œè¿‡æ»¤
- [x] IDè§£æå’ŒåŒ¹é…ç±»å‹è¯†åˆ«
- [x] ç»Ÿè®¡ä¿¡æ¯è·å–

#### ç«¯åˆ°ç«¯æµç¨‹
- [x] å®Œæ•´çš„ç´¢å¼•æ„å»º
- [x] å¤šæ¨¡æ€æ£€ç´¢æŸ¥è¯¢
- [x] æ•°æ®ä¸€è‡´æ€§éªŒè¯
- [x] æ€§èƒ½åŸºå‡†æµ‹è¯•

### ğŸ”„ å¾…æ‰©å±•æµ‹è¯•

1. **æ··åˆæœç´¢æµ‹è¯•**: æ–‡æœ¬+å›¾ç‰‡è”åˆæŸ¥è¯¢
2. **å¤§è§„æ¨¡æ•°æ®æµ‹è¯•**: å¤„ç†æ›´å¤šå›¾ç‰‡æ•°æ®
3. **é”™è¯¯æ¢å¤æµ‹è¯•**: APIé™æµå’Œç½‘ç»œå¼‚å¸¸
4. **å¹¶å‘å‹åŠ›æµ‹è¯•**: é«˜å¹¶å‘åœºæ™¯éªŒè¯
5. **å†…å­˜å‹åŠ›æµ‹è¯•**: å¤§æ‰¹é‡æ•°æ®å¤„ç†

## ä»£ç è´¨é‡æ”¹è¿›

### ä¿®å¤çš„é—®é¢˜
1. **ç»Ÿè®¡ä¸ä¸€è‡´**: ä¿®å¤äº†`process_image_batch`ä¸­çš„å…¨å±€ç»Ÿè®¡æ›´æ–°é—®é¢˜
2. **çº¿ç¨‹å®‰å…¨**: è¯†åˆ«äº†å¹¶å‘å¤„ç†ä¸­çš„æ½œåœ¨é—®é¢˜
3. **é”™è¯¯å¤„ç†**: å¢å¼ºäº†å¼‚å¸¸æƒ…å†µçš„å¤„ç†é€»è¾‘

### ä»£ç è´¨é‡æŒ‡æ ‡
- **æµ‹è¯•è¦†ç›–**: æ ¸å¿ƒåŠŸèƒ½100%è¦†ç›–
- **å¼‚å¸¸å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶
- **æ—¥å¿—è®°å½•**: è¯¦ç»†çš„APIè°ƒç”¨å’Œå¤„ç†æ—¥å¿—
- **æ€§èƒ½ç›‘æ§**: å®æ—¶çš„å¤„ç†ç»Ÿè®¡å’Œæ—¶é—´è®°å½•

## éƒ¨ç½²å»ºè®®

### ç”Ÿäº§ç¯å¢ƒé…ç½®
```python
# æ¨èçš„ç”Ÿäº§é…ç½®
IndexingPipeline(
    batch_size=10,          # é€‚ä¸­çš„æ‰¹å¤„ç†å¤§å°
    max_workers=4,          # æ§åˆ¶å¹¶å‘é¿å…APIé™åˆ¶
    auto_save=True,         # å¯ç”¨è‡ªåŠ¨ä¿å­˜
)

RetrievalPipeline(
    similarity_threshold=0.3,  # åˆç†çš„ç›¸ä¼¼åº¦é˜ˆå€¼
    default_top_k=10,         # é»˜è®¤è¿”å›ç»“æœæ•°
)
```

### ç›‘æ§è¦ç‚¹
1. **APIè°ƒç”¨é¢‘ç‡**: é¿å…è§¦å‘é™æµ
2. **å¤„ç†æˆåŠŸç‡**: ç›‘æ§å¤±è´¥ç‡å’Œé‡è¯•
3. **å†…å­˜ä½¿ç”¨**: å¤§æ‰¹é‡å¤„ç†æ—¶çš„å†…å­˜ç®¡ç†
4. **å¤„ç†æ—¶é—´**: å•å¼ å›¾ç‰‡å’Œæ‰¹é‡å¤„ç†çš„æ—¶é—´

## æ€»ç»“

### ğŸ‰ æµ‹è¯•æˆåŠŸè¦ç‚¹

1. **å®Œæ•´åŠŸèƒ½éªŒè¯**: æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½åœ¨çœŸå®APIç¯å¢ƒä¸‹æ­£å¸¸å·¥ä½œ
2. **æ€§èƒ½ç¬¦åˆé¢„æœŸ**: å¤„ç†é€Ÿåº¦å’Œèµ„æºä½¿ç”¨åœ¨åˆç†èŒƒå›´å†…
3. **é”™è¯¯å¤„ç†å¥å£®**: å„ç§å¼‚å¸¸æƒ…å†µéƒ½æœ‰ç›¸åº”çš„å¤„ç†æœºåˆ¶
4. **æ•°æ®ä¸€è‡´æ€§**: ç´¢å¼•æ„å»ºå’Œæ£€ç´¢æŸ¥è¯¢çš„æ•°æ®å®Œå…¨ä¸€è‡´
5. **APIé›†æˆç¨³å®š**: ä¸DashScope APIçš„é›†æˆç¨³å®šå¯é 

### ğŸ“ˆ é¡¹ç›®ä»·å€¼

- **ç”Ÿäº§å°±ç»ª**: é€šè¿‡çœŸå®APIæµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒ
- **åŠŸèƒ½å®Œæ•´**: å®ç°äº†ä»å›¾ç‰‡è§£æåˆ°æ£€ç´¢æŸ¥è¯¢çš„å®Œæ•´æµç¨‹
- **æ€§èƒ½å¯é **: åœ¨æµ‹è¯•ç¯å¢ƒä¸‹è¡¨ç°ç¨³å®šï¼Œæ€§èƒ½æŒ‡æ ‡è‰¯å¥½
- **æ‰©å±•å‹å¥½**: æ¶æ„è®¾è®¡æ”¯æŒåç»­åŠŸèƒ½æ‰©å±•å’Œä¼˜åŒ–

### ğŸ” ä¸‹ä¸€æ­¥è®¡åˆ’

1. **æ€§èƒ½ä¼˜åŒ–**: åŸºäºæµ‹è¯•ç»“æœä¼˜åŒ–æ‰¹å¤„ç†å’Œå¹¶å‘ç­–ç•¥
2. **åŠŸèƒ½æ‰©å±•**: æ·»åŠ æ··åˆæœç´¢å’Œé«˜çº§æŸ¥è¯¢åŠŸèƒ½
3. **ç›‘æ§å®Œå–„**: æ·»åŠ æ›´å®Œæ•´çš„ç”Ÿäº§ç¯å¢ƒç›‘æ§
4. **æ–‡æ¡£æ›´æ–°**: åŸºäºæµ‹è¯•ç»“æœæ›´æ–°ä½¿ç”¨æŒ‡å—

---

**æµ‹è¯•å®Œæˆæ—¶é—´**: 2025-08-19
**æµ‹è¯•ç¯å¢ƒ**: MacOS Darwin 24.6.0, Python 3.9.6
**APIæä¾›å•†**: é˜¿é‡Œäº‘DashScope
**æµ‹è¯•ç»“æœ**: âœ… å…¨éƒ¨é€šè¿‡ (10/10)
**å»ºè®®çŠ¶æ€**: ğŸš€ ç”Ÿäº§å°±ç»ª
